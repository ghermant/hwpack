#!/usr/bin/make -f

# the upstream build passes LDFLAGS directly to ld instead of calling gcc for
# linking; so instead of passing -Wl,foo in LDFLAGS as in automake builds, one
# should set LDFLAGS to foo directly
comma := ,
LDFLAGS := $(patsubst -Wl$(comma)%,%,$(LDFLAGS))

DEB_HOST_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
export CROSS_COMPILE=$(DEB_HOST_GNU_TYPE)-
endif
#export DH_VERBOSE=1
#export DH_OPTIONS=-v

PLATFORMS= \
	  ca9x4_ct_vxp \
	  mx51evk \
	  omap3_beagle \
	  omap4_panda

%:
	dh --with quilt $@

override_dh_auto_configure:
	@

override_dh_auto_clean:
	$(MAKE) distclean
	rm -rf debian/build

override_dh_auto_build:
	for plat in $(PLATFORMS); do \
		$(MAKE) O=debian/build/$$plat mrproper; \
		$(MAKE) O=debian/build/$$plat $${plat}_config; \
		$(MAKE) O=debian/build/$$plat; \
#		mkdir -p debian/build/$$plat; touch debian/build/$$plat/u-boot.bin; \
	done

override_dh_auto_install:
	for plat in $(PLATFORMS); do \
	    install -D -m644 debian/build/$$plat/u-boot.bin debian/tmp/usr/lib/u-boot/u-boot-$$plat.bin; \
	done
